import{r as e,e as q,j as n}from"./index-Czv1AGCs.js";import{c as H,g as K,n as L,u as z,b as X,a as Z,d as J,e as Q}from"./consistency-BpvqZ4ZH.js";const x=35,F=.5,N=["#E87C3F","#D45B3A","#E8A84A","#C4783C"];function P(r){if(r<=0)return-3;if(r>=1)return 3;const b=-1.0976,c=.2422,w=-.3456,R=.0527,T=r<.5?r:1-r,a=Math.sqrt(-2*Math.log(T));let E=a+(b+c*a)/(1+w*a+R*a*a);return r<.5?-E:E}function et({ageBand:r,onComplete:b}){const[c,w]=e.useState(()=>H(r)),[R,T]=e.useState([]),[a,E]=e.useState(0),[h,A]=e.useState([]),[j,B]=e.useState(0),[U,O]=e.useState(0),[M,_]=e.useState(0),[C,G]=e.useState(!1),y=e.useRef(null),g=e.useRef({}),D=e.useRef({}),S=e.useCallback(()=>{y.current&&clearTimeout(y.current),Object.values(g.current).forEach(clearTimeout),g.current={}},[]);e.useEffect(()=>()=>S(),[S]);const k=e.useCallback(()=>{if(a>=x)return;const t=Math.random()<F,{fallDuration:i,tapWindow:o}=K(c.b),l=10+Math.random()*80,m=Math.floor(Math.random()*N.length),d={id:a,isTarget:t,x:l,color:N[m],fallDuration:i,tapWindow:o,tapped:!1,missed:!1,active:!0,spawnTime:performance.now()};D.current[a]=performance.now(),T(p=>[...p,d]),E(p=>p+1);const u=setTimeout(()=>{T(p=>p.map(f=>f.id===d.id&&!f.tapped&&f.active?(f.isTarget&&(O(v=>v+1),A(v=>[...v,{correct:!1,rt:i,rtNorm:L(i,r),type:"omission",module:"PS"}])),{...f,active:!1,missed:!0}):f))},i);g.current[d.id]=u},[a,c.b,r]);e.useEffect(()=>{if(C||a>=x){if(a>=x&&!C){const i=setTimeout(()=>{V()},2e3);return()=>clearTimeout(i)}return}const t=600+Math.random()*800;return y.current=setTimeout(k,t),()=>{y.current&&clearTimeout(y.current)}},[a,C,k]);const I=e.useCallback(t=>{T(i=>i.map(o=>{if(o.id===t&&o.active&&!o.tapped){const l=performance.now()-(D.current[t]??performance.now()),m=L(l,r);if(o.isTarget){B(u=>u+1);const d=z(c,!0,l,r);w(d),A(u=>[...u,{correct:!0,rt:l,rtNorm:m,type:"hit",module:"PS"}])}else{_(u=>u+1);const d=z(c,!1,l,r);w(d),A(u=>[...u,{correct:!1,rt:l,rtNorm:m,type:"commission",module:"PS"}])}return g.current[t]&&clearTimeout(g.current[t]),{...o,tapped:!0,active:!1}}return o}))},[c,r]),V=e.useCallback(()=>{G(!0),S();const t=x*F,i=Math.min(Math.max(j/Math.max(t,1),.01),.99),o=Math.min(Math.max(M/Math.max(x-t,1),.01),.99),l=P(i)-P(o),m=h.filter(s=>s.type==="hit").map(s=>s.rt),d=X(m.length>1?m:h.map(s=>s.rt)),u=m.length>0?m.reduce((s,$)=>s+$,0)/m.length:1400,p=Z(h,6)||u,f=J(h,p),v=q(h.map(s=>({correct:s.correct,rtNorm:s.rtNorm,rt:s.rt})),d),W=Q(h.map(s=>s.rt).filter(s=>s>0));b({theta:c.theta,thetaSE:c.se,thetaCI:c.ci,itv:d,ddm:v,engagementFatigued:f.fatigued,trials:h,extras:{dPrime:l,hitRate:i,falseAlarmRate:o,commissionRate:o,omissionRate:1-i,exgauss:W}})},[j,M,h,c.theta,c.se,c.ci,b,S]);return n.jsxs("div",{className:"game-area",style:{background:"#D6E8D0",position:"relative",overflow:"hidden"},children:[n.jsxs("svg",{viewBox:"0 0 800 600",style:{position:"absolute",inset:0,width:"100%",height:"100%"},"aria-hidden":"true",children:[n.jsx("rect",{x:"0",y:"0",width:"800",height:"600",fill:"#D6E8D0"}),n.jsx("ellipse",{cx:"200",cy:"-20",rx:"250",ry:"120",fill:"#5B8C5A",opacity:"0.4"}),n.jsx("ellipse",{cx:"600",cy:"-40",rx:"300",ry:"130",fill:"#4A7C4A",opacity:"0.3"}),n.jsx("ellipse",{cx:"400",cy:"-10",rx:"200",ry:"100",fill:"#6B9C6A",opacity:"0.35"}),n.jsx("rect",{x:"0",y:"540",width:"800",height:"60",rx:"0",fill:"#8B6B4E",opacity:"0.6"})]}),n.jsx("div",{style:{position:"absolute",top:8,left:0,right:0,textAlign:"center",fontFamily:"var(--font-game, 'Nunito')",fontSize:"clamp(0.8rem, 2vw, 1rem)",color:"#2C3E35",zIndex:10},children:"Tap the leaves with a ⭐!"}),R.map(t=>{if(!t.active&&!t.tapped&&!t.missed)return null;const i=t.missed&&!t.tapped,o=t.tapped;return n.jsx("button",{onClick:()=>I(t.id),onKeyDown:l=>{(l.key==="Enter"||l.key===" ")&&I(t.id)},role:"button",tabIndex:t.active?0:-1,"aria-label":t.isTarget?"Star leaf - tap this!":"Regular leaf",disabled:!t.active,style:{position:"absolute",left:`${t.x}%`,top:0,width:56,height:56,border:"none",background:"transparent",cursor:t.active?"pointer":"default",padding:0,zIndex:5,animation:o?"crumple 0.3s ease-out forwards":i?"crumple 0.4s ease-out forwards":`leafFall ${t.fallDuration}ms linear forwards`,pointerEvents:t.active?"auto":"none",transform:"translateX(-50%)"},children:n.jsxs("svg",{width:"56",height:"56",viewBox:"0 0 56 56",children:[n.jsx("path",{d:"M28 4 C18 8, 6 18, 8 30 C10 42, 22 52, 28 52 C34 52, 46 42, 48 30 C50 18, 38 8, 28 4Z",fill:t.color}),n.jsx("line",{x1:"28",y1:"8",x2:"28",y2:"48",stroke:"#8B5E3C",strokeWidth:"1.5",opacity:"0.4"}),t.isTarget&&n.jsx("text",{x:"28",y:"32",textAnchor:"middle",dominantBaseline:"middle",fontSize:"16",children:"⭐"})]})},t.id)}),n.jsxs("div",{style:{position:"absolute",bottom:8,right:12,fontFamily:"var(--font-game, 'Nunito')",fontSize:"0.8rem",color:"#6B7F78",zIndex:10},"aria-hidden":"true",children:[a,"/",x]})]})}export{et as default};
